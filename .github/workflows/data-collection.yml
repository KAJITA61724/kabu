name: 自動データ収集

on:
  schedule:
    # 平日の市場時間中に3回実行（4時間制限対策）
    # UTC時刻で指定（JST - 9時間）
    - cron: '0 0 * * 1-5'   # 月-金 9:00 JST
    - cron: '0 3 * * 1-5'   # 月-金 12:00 JST
    - cron: '0 5 * * 1-5'   # 月-金 14:00 JST
  workflow_dispatch:  # 手動実行も可能

jobs:
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: チェックアウト
      uses: actions/checkout@v4
      
    - name: Pythonセットアップ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: 依存関係インストール
      run: |
        pip install yfinance pandas jpholiday
        
    - name: データ収集実行
      run: |
        cd RakutenTradingSystem
        python3 data_collection/automated_data_collection.py
      continue-on-error: false
        
    - name: データベースをアップロード（artifact）
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: market-data-${{ github.run_number }}
        path: RakutenTradingSystem/data/market_data.db
        retention-days: 90
        if-no-files-found: warn
        
    - name: 統計表示
      if: always()
      run: |
        cd RakutenTradingSystem
        python3 -c "
        import sqlite3
        import os
        db_path = 'data/market_data.db'
        if os.path.exists(db_path):
            try:
                conn = sqlite3.connect(db_path)
                cursor = conn.cursor()
                cursor.execute('SELECT COUNT(*) FROM chart_data_1min')
                total = cursor.fetchone()[0]
                cursor.execute('SELECT MAX(datetime) FROM chart_data_1min')
                latest = cursor.fetchone()[0]
                print(f'✅ 総件数: {total:,}件')
                print(f'⏰ 最新: {latest}')
                conn.close()
            except Exception as e:
                print(f'⚠️ データベース読み込みエラー: {e}')
        else:
            print('⚠️ データベースファイルが見つかりません')
        "
